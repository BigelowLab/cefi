---
title: "CEFI"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[NOAA's Physical Science Laboratory (PSL)](https://psl.noaa.gov/) [Climate Ecosystems and Fisheries Initiative Portal](https://psl.noaa.gov/cefi_portal/) serves historical and forecast data useful in ecological studies. Data is served using a [THREDDS](https://psl.noaa.gov/thredds/catalog/Projects/CEFI/regional_mom6/catalog.html) catalog, but PSL also makes [tabular catalogs](https://psl.noaa.gov/cefi_portal/var_list_northwest_atlantic_hist_run.html) available, too.

# Requirements

 + [R v4.1+](https://www.r-project.org/)
 + [rlang](https://CRAN.R-project.org/package=rlang)
 + [dplyr](https://CRAN.R-project.org/package=dplyr)
 + [sf](https://CRAN.R-project.org/package=sf)
 + [stars](https://CRAN.R-project.org/package=stars)
 + [jsonlite](https://CRAN.R-project.org/package=jsonlite)
 + [tidync](https://CRAN.R-project.org/package=tidync)

# Installation

```
remotes::install_github("BigelowLab/cefi")
```

# Usage

Load the libraries needed.
```{r}
suppressPackageStartupMessages({
  library(cefi)
  library(tidync)
  library(stars)
  library(dplyr)
})
```

## Catalogs

```{r}
uri = catalog_uri(region = "Northwest Atlantic", period = "history")
hist = read_catalog(uri) |>
  dplyr::glimpse()
```
```{r}
uri = catalog_uri(region = "Northwest Atlantic", period = "forecast")
fcst = read_catalog(uri) |>
  dplyr::glimpse()
```
# Getting data

To get data select one row from either catalog, and open that resource.

```{r}
nc = hist |>
  dplyr::filter(Varible_Name == "btm_o2") |>
  open_cefi()
nc
```

Next we filter the array, so that we can collect a subset of the data. This "overwrites" the original object, by tagging those dimensions we filter on with basic array navigation information that matches out request. You can see the change in the `dim` and `max` values of the active dimensions.

```{r}
nc = tidync::hyper_filter(nc, time = dplyr::between(time, 1,6))
nc
```

```{r}
s = cefi_var(nc)
plot(s)
```
